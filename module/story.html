<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë§¥ë½ ê¸°ì–µ - ìˆœì„œ ë§ì¶”ê¸° (Prototype)</title>
  <style>
    :root { --bg:#0b0f14; --card:#121925; --muted:#8aa0b8; --text:#e8f0fb; --accent:#6aa6ff; --ok:#3ad29f; --bad:#ff5a6a; }
    * { box-sizing: border-box; }
    body {
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #1b2b42 0%, transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, #202a3b 0%, transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    .wrap { max-width: 920px; margin: 0 auto; padding: 22px 16px 40px; }
    .top {
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .title {
      display:flex; flex-direction:column; gap:6px;
    }
    h1 { margin:0; font-size: 20px; letter-spacing: -0.2px; }
    .sub { margin:0; color: var(--muted); font-size: 13px; line-height: 1.4; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      background: rgba(255,255,255,0.06);
      color: var(--muted); font-size: 12px;
    }
    .board {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
    }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .storyBox { margin-top: 10px; padding: 12px; border-radius: 14px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07); }
    .storyTitle { font-size: 14px; margin: 0 0 6px; }
    .storyHint { margin:0; color: var(--muted); font-size: 13px; line-height:1.45; }

    .list {
      margin-top: 12px;
      display:flex; flex-direction:column; gap:10px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(0,0,0,0.18);
      border: 1px dashed rgba(255,255,255,0.12);
      min-height: 220px;
    }
    .item {
      display:flex; gap:10px; align-items:flex-start;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      cursor: grab;
      user-select: none;
      touch-action: none;
      transition: transform 0.15s ease, opacity 0.15s ease, background 0.3s ease, border-color 0.3s ease;
    }
    .item:active { cursor: grabbing; }
    .item:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .num {
      width: 28px; height: 28px; border-radius: 10px;
      background: rgba(106,166,255,0.18);
      border: 1px solid rgba(106,166,255,0.35);
      display:flex; align-items:center; justify-content:center;
      color: var(--accent); font-weight: 700; font-size: 12px;
      flex: 0 0 auto;
      transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }
    .txt { font-size: 14px; line-height: 1.5; color: var(--text); }
    .item.dragging { opacity: 0.55; transform: scale(0.97); }
    .item.over { outline: 2px solid rgba(106,166,255,0.55); }
    .item.touch-dragging {
      opacity: 0.85;
      transform: scale(1.02);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      z-index: 100;
    }

    /* ì •ë‹µ/ì˜¤ë‹µ ê°œë³„ í‘œì‹œ */
    .item.correct {
      background: rgba(58,210,159,0.15);
      border-color: rgba(58,210,159,0.45);
    }
    .item.correct .num {
      background: rgba(58,210,159,0.25);
      border-color: rgba(58,210,159,0.55);
      color: var(--ok);
    }
    .item.wrong {
      background: rgba(255,90,106,0.12);
      border-color: rgba(255,90,106,0.40);
    }
    .item.wrong .num {
      background: rgba(255,90,106,0.20);
      border-color: rgba(255,90,106,0.50);
      color: var(--bad);
    }

    /* ì •ë‹µ ì‹œ ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes celebrate {
      0% { transform: scale(1); }
      25% { transform: scale(1.03); }
      50% { transform: scale(0.98); }
      75% { transform: scale(1.01); }
      100% { transform: scale(1); }
    }
    .item.celebrate {
      animation: celebrate 0.5s ease;
    }

    .btns { display:flex; gap:10px; flex-wrap:wrap; }
    button {
      border: 0; border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      background: rgba(255,255,255,0.08);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.12);
      cursor:pointer;
      transition: background 0.2s ease;
    }
    button:hover { background: rgba(255,255,255,0.11); }
    button:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    button.primary {
      background: rgba(106,166,255,0.18);
      border: 1px solid rgba(106,166,255,0.40);
      color: #dcebff;
    }
    button.danger {
      background: rgba(255,90,106,0.14);
      border: 1px solid rgba(255,90,106,0.35);
    }
    .status {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
      min-height: 44px;
      display:flex; align-items:center;
    }
    .status.ok { color: #b9ffe7; border-color: rgba(58,210,159,0.35); background: rgba(58,210,159,0.10); }
    .status.bad { color: #ffd0d6; border-color: rgba(255,90,106,0.35); background: rgba(255,90,106,0.10); }
    .footer {
      margin-top: 14px; color: rgba(138,160,184,0.9); font-size: 12px; line-height: 1.5;
    }
    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      padding: 2px 6px; border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }

    /* í‚¤ë³´ë“œ ì¡°ì‘ ì•ˆë‚´ */
    .a11y-hint {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(106,166,255,0.08);
      border: 1px solid rgba(106,166,255,0.20);
      font-size: 12px;
      color: var(--muted);
    }

    /* ìŠ¤í¬ë¦° ë¦¬ë” ì „ìš© í…ìŠ¤íŠ¸ */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>ë§¥ë½ ê¸°ì–µ: ìˆœì„œ ë§ì¶”ê¸°</h1>
        <p class="sub">ë¬¸ì¥(ë˜ëŠ” ì§§ì€ ì¥ë©´)ì„ ë“œë˜ê·¸í•´ì„œ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ë°°ì—´í•´ë³´ì„¸ìš”. <span class="kbd">ì •ë‹µ í™•ì¸</span>ì„ ëˆ„ë¥´ë©´ ì±„ì í•©ë‹ˆë‹¤.</p>
      </div>
      <div class="pill" aria-live="polite">
        <span>ì§„í–‰</span>
        <strong id="progressText">1 / 3</strong>
      </div>
    </div>

    <div class="board" role="main">
      <div class="row">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <div class="pill">ë‚œì´ë„: <strong id="levelText">ì‰¬ì›€</strong></div>
          <div class="pill" aria-live="polite">ì‹œë„: <strong id="triesText">0</strong></div>
        </div>
        <div class="btns" role="group" aria-label="ê²Œì„ ì»¨íŠ¸ë¡¤">
          <button id="btnShuffle" class="danger" type="button" aria-label="ë¬¸ì¥ ë‹¤ì‹œ ì„ê¸°">ë‹¤ì‹œ ì„ê¸°</button>
          <button id="btnHint" type="button" aria-label="íŒíŠ¸ ë³´ê¸°">íŒíŠ¸</button>
          <button id="btnCheck" class="primary" type="button" aria-label="ì •ë‹µ í™•ì¸í•˜ê¸°">ì •ë‹µ í™•ì¸</button>
          <button id="btnNext" type="button" disabled aria-label="ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™">ë‹¤ìŒ</button>
        </div>
      </div>

      <div class="storyBox">
        <p class="storyTitle"><strong id="storyTitle">â€”</strong></p>
        <p class="storyHint" id="storyDesc">â€”</p>
      </div>

      <div class="list" id="list" role="list" aria-label="ìˆœì„œ ë§ì¶”ê¸° ë¬¸ì¥ ëª©ë¡"></div>

      <div class="a11y-hint">
        ğŸ’¡ í‚¤ë³´ë“œ: ì¹´ë“œ ì„ íƒ í›„ <span class="kbd">â†‘</span> <span class="kbd">â†“</span> í‚¤ë¡œ ì´ë™, <span class="kbd">Space</span>ë¡œ ì„ íƒ/í•´ì œ | ëª¨ë°”ì¼: ê¸¸ê²Œ ëˆŒëŸ¬ ë“œë˜ê·¸
      </div>

      <div class="status" id="status" role="status" aria-live="polite">
        ë¬¸ì¥ ì¹´ë“œë¥¼ ë“œë˜ê·¸í•´ì„œ ìˆœì„œë¥¼ ë°”ê¾¼ ë’¤, <strong style="margin-left:6px;">ì •ë‹µ í™•ì¸</strong>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </div>

      <div class="footer">
        <div>â€¢ ì ‘ê·¼ì„±/ê³ ë ¹ì¸µ ê³ ë ¤: í° ë²„íŠ¼, ì§§ì€ ë¬¸ì¥, ì‹¤íŒ¨ íŒ¨ë„í‹° ì—†ìŒ</div>
        <div>â€¢ ìš´ì˜ ì•„ì´ë””ì–´: "ì˜¤ëŠ˜ì˜ ê¸°ì‚¬ ìš”ì•½ 3ë¬¸ì¥ ìˆœì„œ ë§ì¶”ê¸°"ë¡œ ë§¤ì¼ 1ê°œ ì œê³µ</div>
      </div>
    </div>
  </div>

  <script>
    // ES6 ìµœì†Œí™”(ì‚¬ìš©ì ì„ í˜¸): var/function ìœ„ì£¼ë¡œ ì‘ì„±

    var stories = [
      {
        title: "ì•„ì¹¨ ë£¨í‹´",
        desc: "ì¼ìƒ íë¦„ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ìˆœì„œë¥¼ ë§ì¶°ë³´ì„¸ìš”.",
        level: "ì‰¬ì›€",
        steps: [
          "ì•ŒëŒì´ ìš¸ë ¤ ëˆˆì„ ëœ¬ë‹¤.",
          "ì„¸ìˆ˜ë¥¼ í•˜ê³  ì´ë¥¼ ë‹¦ëŠ”ë‹¤.",
          "ì•„ì¹¨ì„ ê°„ë‹¨íˆ ë¨¹ëŠ”ë‹¤.",
          "ê°€ë°©ì„ ì±™ê²¨ ì§‘ì„ ë‚˜ì„ ë‹¤."
        ]
      },
      {
        title: "ì¹´í˜ì—ì„œ ì£¼ë¬¸í•˜ê¸°",
        desc: "ì‹¤ì œë¡œ ê²½í—˜í•˜ëŠ” ìˆœì„œë¥¼ ë– ì˜¬ë¦¬ë©´ ì‰½ê²Œ ë§ì¶œ ìˆ˜ ìˆì–´ìš”.",
        level: "ì‰¬ì›€",
        steps: [
          "ë©”ë‰´ë¥¼ ë³´ê³  ë§ˆì‹¤ ê²ƒì„ ê³ ë¥¸ë‹¤.",
          "ì¹´ìš´í„°ì—ì„œ ì£¼ë¬¸í•˜ê³  ê²°ì œí•œë‹¤.",
          "ì§„ë™ë²¨(ë˜ëŠ” í˜¸ì¶œ)ì„ ê¸°ë‹¤ë¦°ë‹¤.",
          "ìŒë£Œë¥¼ ë°›ì•„ ìë¦¬ë¡œ ê°„ë‹¤."
        ]
      },
      {
        title: "ê¸°ì‚¬ ì½ê³  ê³µìœ í•˜ê¸°(ì–¸ë¡ ì‚¬í˜•)",
        desc: "ë‰´ìŠ¤ ì†Œë¹„ íë¦„ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì‹œë‚˜ë¦¬ì˜¤ì…ë‹ˆë‹¤.",
        level: "ë³´í†µ",
        steps: [
          "ì œëª©ì„ ë³´ê³  ê´€ì‹¬ ê¸°ì‚¬ë¥¼ ì„ íƒí•œë‹¤.",
          "ë³¸ë¬¸ì„ ì½ìœ¼ë©° í•µì‹¬ì„ íŒŒì•…í•œë‹¤.",
          "í•µì‹¬ ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ì •ë¦¬í•œë‹¤.",
          "ê°€ì¡±/ì§€ì¸ì—ê²Œ ë§í¬ë¥¼ ê³µìœ í•œë‹¤."
        ]
      }
    ];

    var idx = 0;
    var tries = 0;
    var hintShown = false;
    var dragSrcEl = null;

    // í„°ì¹˜ ë“œë˜ê·¸ìš© ë³€ìˆ˜
    var touchDragEl = null;
    var touchOffsetY = 0;

    // í‚¤ë³´ë“œ ì„ íƒ ëª¨ë“œ
    var selectedForMove = null;

    function $(id){ return document.getElementById(id); }

    // í…ìŠ¤íŠ¸ ì´ìŠ¤ì¼€ì´í”„ (XSS ë°©ì§€)
    function escapeHtml(text) {
      var div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    function shuffleArray(arr) {
      // Fisher-Yates
      var a = arr.slice();
      for (var i = a.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = a[i]; a[i] = a[j]; a[j] = tmp;
      }
      return a;
    }

    function setStatus(msg, kind) {
      var el = $("status");
      el.className = "status";
      if (kind === "ok") el.className = "status ok";
      if (kind === "bad") el.className = "status bad";
      el.innerHTML = msg;
    }

    function clearItemStates() {
      var list = $("list");
      var kids = list.children;
      for (var i = 0; i < kids.length; i++) {
        kids[i].classList.remove("correct", "wrong", "celebrate");
      }
    }

    function renderStory() {
      var s = stories[idx];
      $("storyTitle").textContent = s.title;
      $("storyDesc").textContent = s.desc;
      $("levelText").textContent = s.level;
      $("progressText").textContent = (idx + 1) + " / " + stories.length;
      $("triesText").textContent = String(tries);

      $("btnNext").disabled = true;
      hintShown = false;
      selectedForMove = null;

      // ì„ì–´ì„œ ë Œë”ë§
      var mixed = shuffleArray(s.steps);
      renderList(mixed);

      setStatus("ë¬¸ì¥ ì¹´ë“œë¥¼ ë“œë˜ê·¸í•´ì„œ ìˆœì„œë¥¼ ë°”ê¾¼ ë’¤, <strong style='margin-left:6px;'>ì •ë‹µ í™•ì¸</strong>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.", "");
    }

    function renderList(items) {
      var list = $("list");
      list.innerHTML = "";

      for (var i = 0; i < items.length; i++) {
        var div = document.createElement("div");
        div.className = "item";
        div.setAttribute("draggable", "true");
        div.setAttribute("data-text", items[i]);
        div.setAttribute("role", "listitem");
        div.setAttribute("tabindex", "0");
        div.setAttribute("aria-label", "ë¬¸ì¥ " + (i + 1) + ": " + items[i] + ". ë°©í–¥í‚¤ë¡œ ì´ë™, ìŠ¤í˜ì´ìŠ¤ë¡œ ì„ íƒ");

        var num = document.createElement("div");
        num.className = "num";
        num.setAttribute("aria-hidden", "true");
        num.textContent = String(i + 1);

        var txt = document.createElement("div");
        txt.className = "txt";
        txt.textContent = items[i];

        div.appendChild(num);
        div.appendChild(txt);

        bindDnD(div);
        bindTouch(div);
        bindKeyboard(div);
        list.appendChild(div);
      }
      renumber();
    }

    function renumber() {
      var list = $("list");
      var kids = list.children;
      for (var i = 0; i < kids.length; i++) {
        var num = kids[i].querySelector(".num");
        if (num) num.textContent = String(i + 1);
        kids[i].setAttribute("aria-label", "ë¬¸ì¥ " + (i + 1) + ": " + kids[i].getAttribute("data-text") + ". ë°©í–¥í‚¤ë¡œ ì´ë™, ìŠ¤í˜ì´ìŠ¤ë¡œ ì„ íƒ");
      }
    }

    // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ì•¤ ë“œë¡­
    function bindDnD(el) {
      el.addEventListener("dragstart", function(e){
        dragSrcEl = el;
        el.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        try { e.dataTransfer.setData("text/plain", el.getAttribute("data-text")); } catch (err) {}
      });

      el.addEventListener("dragend", function(){
        el.classList.remove("dragging");
        clearOver();
        renumber();
      });

      el.addEventListener("dragover", function(e){
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        el.classList.add("over");
      });

      el.addEventListener("dragleave", function(){
        el.classList.remove("over");
      });

      el.addEventListener("drop", function(e){
        e.preventDefault();
        if (!dragSrcEl || dragSrcEl === el) return;

        var list = $("list");
        var children = list.children;

        var srcIndex = indexOfChild(children, dragSrcEl);
        var dstIndex = indexOfChild(children, el);

        if (srcIndex < 0 || dstIndex < 0) return;

        if (srcIndex < dstIndex) {
          list.insertBefore(dragSrcEl, el.nextSibling);
        } else {
          list.insertBefore(dragSrcEl, el);
        }

        clearOver();
        clearItemStates();
        renumber();
      });
    }

    // í„°ì¹˜ ë“œë˜ê·¸ ì•¤ ë“œë¡­
    function bindTouch(el) {
      el.addEventListener("touchstart", function(e) {
        if (e.touches.length !== 1) return;
        
        touchDragEl = el;
        var touch = e.touches[0];
        var rect = el.getBoundingClientRect();
        touchStartY = touch.clientY;
        touchOffsetY = touch.clientY - rect.top;
        
        el.classList.add("touch-dragging");
      }, { passive: true });

      el.addEventListener("touchmove", function(e) {
        if (!touchDragEl || touchDragEl !== el) return;
        e.preventDefault();

        var touch = e.touches[0];
        var list = $("list");
        var kids = list.children;
        
        // ë‹¤ë¥¸ ìš”ì†Œì™€ ìœ„ì¹˜ ë¹„êµí•˜ì—¬ ìˆœì„œ ë³€ê²½
        for (var i = 0; i < kids.length; i++) {
          if (kids[i] === el) continue;
          
          var kidRect = kids[i].getBoundingClientRect();
          var kidCenter = kidRect.top + kidRect.height / 2;
          
          if (touch.clientY < kidCenter && indexOfChild(kids, el) > i) {
            list.insertBefore(el, kids[i]);
            clearItemStates();
            renumber();
            break;
          } else if (touch.clientY > kidCenter && indexOfChild(kids, el) < i) {
            list.insertBefore(el, kids[i].nextSibling);
            clearItemStates();
            renumber();
            break;
          }
        }
      }, { passive: false });

      el.addEventListener("touchend", function(e) {
        if (touchDragEl === el) {
          el.classList.remove("touch-dragging");
          touchDragEl = null;
          renumber();
        }
      });

      el.addEventListener("touchcancel", function(e) {
        if (touchDragEl === el) {
          el.classList.remove("touch-dragging");
          touchDragEl = null;
          renumber();
        }
      });
    }

    // í‚¤ë³´ë“œ ì¡°ì‘
    function bindKeyboard(el) {
      el.addEventListener("keydown", function(e) {
        var list = $("list");
        var kids = list.children;
        var currentIndex = indexOfChild(kids, el);

        if (e.key === " " || e.key === "Spacebar") {
          e.preventDefault();
          
          if (selectedForMove === el) {
            // ì„ íƒ í•´ì œ
            selectedForMove = null;
            el.style.outline = "";
            announceToScreenReader("ì„ íƒ í•´ì œë¨");
          } else if (selectedForMove) {
            // ìœ„ì¹˜ êµí™˜
            var srcIndex = indexOfChild(kids, selectedForMove);
            if (srcIndex < currentIndex) {
              list.insertBefore(selectedForMove, el.nextSibling);
            } else {
              list.insertBefore(selectedForMove, el);
            }
            selectedForMove.style.outline = "";
            selectedForMove = null;
            clearItemStates();
            renumber();
            el.focus();
            announceToScreenReader("ìœ„ì¹˜ ë³€ê²½ ì™„ë£Œ");
          } else {
            // ì„ íƒ
            selectedForMove = el;
            el.style.outline = "3px solid " + getComputedStyle(document.documentElement).getPropertyValue('--accent');
            announceToScreenReader("ì„ íƒë¨. ë‹¤ë¥¸ ì¹´ë“œì—ì„œ ìŠ¤í˜ì´ìŠ¤ë¥¼ ëˆŒëŸ¬ ìœ„ì¹˜ë¥¼ êµí™˜í•˜ì„¸ìš”");
          }
        }

        if (e.key === "ArrowUp" && currentIndex > 0) {
          e.preventDefault();
          if (selectedForMove === el) {
            // ì„ íƒëœ ìƒíƒœì—ì„œ ìœ„ë¡œ ì´ë™
            list.insertBefore(el, kids[currentIndex - 1]);
            clearItemStates();
            renumber();
            el.focus();
          } else {
            // í¬ì»¤ìŠ¤ë§Œ ì´ë™
            kids[currentIndex - 1].focus();
          }
        }

        if (e.key === "ArrowDown" && currentIndex < kids.length - 1) {
          e.preventDefault();
          if (selectedForMove === el) {
            // ì„ íƒëœ ìƒíƒœì—ì„œ ì•„ë˜ë¡œ ì´ë™
            list.insertBefore(el, kids[currentIndex + 2] || null);
            clearItemStates();
            renumber();
            el.focus();
          } else {
            // í¬ì»¤ìŠ¤ë§Œ ì´ë™
            kids[currentIndex + 1].focus();
          }
        }

        if (e.key === "Escape" && selectedForMove) {
          selectedForMove.style.outline = "";
          selectedForMove = null;
          announceToScreenReader("ì„ íƒ ì·¨ì†Œë¨");
        }
      });
    }

    // ìŠ¤í¬ë¦° ë¦¬ë” ì•Œë¦¼
    function announceToScreenReader(message) {
      var announcement = document.createElement("div");
      announcement.setAttribute("role", "status");
      announcement.setAttribute("aria-live", "polite");
      announcement.className = "sr-only";
      announcement.textContent = message;
      document.body.appendChild(announcement);
      setTimeout(function() {
        document.body.removeChild(announcement);
      }, 1000);
    }

    function clearOver() {
      var list = $("list");
      var kids = list.children;
      for (var i = 0; i < kids.length; i++) kids[i].classList.remove("over");
    }

    function indexOfChild(htmlCollection, node) {
      for (var i = 0; i < htmlCollection.length; i++) {
        if (htmlCollection[i] === node) return i;
      }
      return -1;
    }

    function getCurrentOrder() {
      var list = $("list");
      var kids = list.children;
      var out = [];
      for (var i = 0; i < kids.length; i++) {
        out.push(kids[i].getAttribute("data-text"));
      }
      return out;
    }

    function arraysEqual(a, b) {
      if (!a || !b) return false;
      if (a.length !== b.length) return false;
      for (var i = 0; i < a.length; i++) {
        if (a[i] !== b[i]) return false;
      }
      return true;
    }

    function showHint() {
      if (hintShown) {
        setStatus("íŒíŠ¸ëŠ” ì´ë¯¸ í‘œì‹œí–ˆì–´ìš”. ë‹¤ì‹œ í•œ ë²ˆ ì •ë‹µ íë¦„(ì›ì¸â†’í–‰ë™â†’ê²°ê³¼)ì„ ë– ì˜¬ë ¤ë³´ì„¸ìš”.", "");
        return;
      }
      hintShown = true;

      var s = stories[idx];
      var msg = "íŒíŠ¸: <strong>ì²« ë¬¸ì¥</strong>ì€ \"" + escapeHtml(s.steps[0]) + "\", <strong>ë§ˆì§€ë§‰ ë¬¸ì¥</strong>ì€ \"" + escapeHtml(s.steps[s.steps.length - 1]) + "\" ì…ë‹ˆë‹¤.";
      setStatus(msg, "");
    }

    function checkAnswer() {
      tries += 1;
      $("triesText").textContent = String(tries);

      var s = stories[idx];
      var now = getCurrentOrder();
      var ok = arraysEqual(now, s.steps);

      var list = $("list");
      var kids = list.children;

      // ê° ì¹´ë“œì— ì •ë‹µ/ì˜¤ë‹µ í‘œì‹œ
      for (var i = 0; i < s.steps.length; i++) {
        kids[i].classList.remove("correct", "wrong", "celebrate");
        if (now[i] === s.steps[i]) {
          kids[i].classList.add("correct");
        } else {
          kids[i].classList.add("wrong");
        }
      }

      if (ok) {
        $("btnNext").disabled = false;
        
        // ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜
        for (var j = 0; j < kids.length; j++) {
          (function(index, kidsRef) {
            setTimeout(function() {
              if (kidsRef[index]) {
                kidsRef[index].classList.add("celebrate");
              }
            }, index * 100);
          })(j, kids);
        }
        
        setStatus("ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰ ë§¥ë½ íë¦„ì´ ì •í™•í•´ìš”. <strong style='margin-left:6px;'>ë‹¤ìŒ</strong>ìœ¼ë¡œ ë„˜ì–´ê°€ë„ ë©ë‹ˆë‹¤.", "ok");
        announceToScreenReader("ì •ë‹µì…ë‹ˆë‹¤! ë‹¤ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§„í–‰í•˜ì„¸ìš”.");
      } else {
        var correctPos = 0;
        for (var k = 0; k < s.steps.length; k++) {
          if (now[k] === s.steps[k]) correctPos += 1;
        }
        setStatus("ì•„ì‰½ì§€ë§Œ ì•„ì§ ì•„ë‹ˆì—ìš”. ë§ëŠ” ìœ„ì¹˜: <strong>" + correctPos + "</strong> / " + s.steps.length + "  (íƒ€ì´ë¨¸ ì—†ì´ ì²œì²œíˆ ë‹¤ì‹œ ë°°ì—´í•´ë³´ì„¸ìš”)", "bad");
        announceToScreenReader("ì˜¤ë‹µì…ë‹ˆë‹¤. " + correctPos + "ê°œê°€ ë§ëŠ” ìœ„ì¹˜ì— ìˆìŠµë‹ˆë‹¤.");
      }
    }

    function reshuffle() {
      var s = stories[idx];
      renderList(shuffleArray(s.steps));
      setStatus("ë¬¸ì¥ì„ ë‹¤ì‹œ ì„ì—ˆìŠµë‹ˆë‹¤. ì´ë²ˆì—” íë¦„(ì›ì¸â†’í–‰ë™â†’ê²°ê³¼)ìœ¼ë¡œ ì ‘ê·¼í•´ë³´ì„¸ìš”.", "");
      $("btnNext").disabled = true;
      selectedForMove = null;
    }

    function nextStory() {
      idx += 1;
      tries = 0;
      if (idx >= stories.length) {
        // ì¢…ë£Œ í™”ë©´
        $("btnNext").disabled = true;
        $("btnCheck").disabled = true;
        $("btnHint").disabled = true;
        $("btnShuffle").disabled = true;

        $("storyTitle").textContent = "ì™„ë£Œ!";
        $("storyDesc").textContent = "ëª¨ë“  ë¬¸ì œë¥¼ í’€ì—ˆìŠµë‹ˆë‹¤.";
        $("levelText").textContent = "â€”";
        $("progressText").textContent = stories.length + " / " + stories.length;

        $("list").innerHTML = "";
        setStatus("ìˆ˜ê³ í–ˆì–´ìš”! âœ…", "ok");
        announceToScreenReader("ëª¨ë“  ë¬¸ì œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!");
        return;
      }
      renderStory();
    }

    // ë²„íŠ¼ ë°”ì¸ë”©
    $("btnHint").addEventListener("click", showHint);
    $("btnCheck").addEventListener("click", checkAnswer);
    $("btnShuffle").addEventListener("click", reshuffle);
    $("btnNext").addEventListener("click", nextStory);

    // ì‹œì‘
    renderStory();
  </script>
</body>
</html>
